<%
  var showFrequency = function(frequency) {
    frequency = parseInt(frequency, 10);
    if (!_.isNumber(frequency) || _.isNaN(frequency)) return 'N/A';
    var base = 1000;
    var treshold = 1000;
    if (frequency >= treshold) {
      return (frequency / base).toFixed(2) + ' GHz';
    } else {
      return frequency + ' MHz';
    }
  };
  var showBandwidth = function(bandwidth) {
    bandwidth = parseInt(bandwidth, 10);
    if (!_.isNumber(bandwidth) || _.isNaN(bandwidth)) return 'N/A';
    return (bandwidth / 1000).toFixed(1) + ' Gbps';
  };
  var showSize = function(bytes, base, treshold) {
    bytes = parseInt(bytes, 10);
    if (!_.isNumber(bytes) || _.isNaN(bytes)) return 'N/A';
    base = base || 1024;
    treshold = treshold || 256;
    var units = ['bytes', 'KB', 'MB', 'GB', 'TB'];
    for (var i = 0; i < units.length; i++) {
      var result = bytes / Math.pow(base, i);
      if (result < treshold) {
        return (result ? result.toFixed(1) : result) + ' ' + units[i];
      }
    }
    return result;
  };
  var showMemorySize = function(bytes) {
    return showSize(bytes, 1024, 1024);
  };
  var showDiskSize = function(bytes) {
    return showSize(bytes, 1000);
  };
  var showPropertyName = function(propertyName) {
    return propertyName.replace(/_/g, ' ');
  };
  var showPropertyValue = function(group, name, value) {
    try {
      if (group == 'memory' && (name == 'total' || name == 'maximum_capacity' || name == 'size')) {
        value = showMemorySize(value);
      } else if (group == 'disks' && name == 'size') {
        value = showDiskSize(value);
      } else if (name == 'size') {
        value = showSize(value);
      } else if (name == 'frequency') {
        value = showFrequency(value);
      } else if (name == 'max_speed' || name == 'current_speed') {
        value = showBandwidth(value);
      }
    } catch (e) {};
    return value;
  };
  var showSummary = function(meta, group) {
    var summary = '';
    try {
      if (group == 'system') {
        summary = (meta.system.manufacturer || '') + ' ' + (meta.system.product || '');
      } else if (group == 'memory') {
        if (_.isArray(meta.memory.devices) && meta.memory.devices.length) {
          var sizes = _.groupBy(_.pluck(meta.memory.devices, 'size'), showMemorySize);
          summary = _.map(_.keys(sizes).sort(), function(size) {return sizes[size].length + ' x ' + size}).join(', ');
          summary += ', ' + showMemorySize(meta.memory.total) + ' total';
        } else {
          summary = showMemorySize(meta.memory.total) + ' total';
        }
      } else if (group == 'disks') {
        summary = meta.disks.length + ' drive';
        summary += meta.disks.length == 1 ? ', ' : 's, ';
        summary += showDiskSize(_.reduce(_.pluck(meta.disks, 'size'), function(sum, n) {return sum + n}, 0)) + ' total';
      } else if (group == 'cpu') {
        var frequencies = _.groupBy(_.pluck(meta.cpu.spec, 'frequency'), showFrequency);
        summary = _.map(_.keys(frequencies).sort(), function(frequency) {return frequencies[frequency].length + ' x ' + frequency}).join(', ');
      } else if (group == 'interfaces') {
        var bandwidths = _.groupBy(_.pluck(meta.interfaces, 'current_speed'), showBandwidth);
        summary = _.map(_.keys(bandwidths).sort(), function(bandwidth) {return bandwidths[bandwidth].length + ' x ' + bandwidth}).join(', ');
      }
    } catch (e) {};
    return summary;
  };
  var sortEntryProperties = function(entry) {
    var properties = _.keys(entry);
    if (_.has(entry, 'name')) {
      properties = ['name'].concat(_.keys(_.omit(entry, 'name')));
    }
    return properties;
  };
%>
<div class="modal-header">
  <button type="button" class="close" data-dismiss="modal">&times;</button>
  <h3><%- node.get('name') %></h3>
</div>
<div class="modal-body node-popup enable-selection">
  <div class="row-fluid">
    <div class="span5"><div class="node-image-outline"></div></div>
    <div class="span7">
      <div><strong>Manufacturer: </strong><%- node.get('manufacturer') ? node.get('manufacturer') : 'N/A' %></div>
      <div><strong>MAC Address: </strong><%- node.get('mac') ? node.get('mac') : 'N/A' %></div>
      <div><strong>FQDN: </strong><%- (node.get('meta').system || {}).fqdn || node.get('fqdn') || 'N/A' %></div>
    </div>
  </div>
  <div class="accordion" id="nodeDetailsAccordion">
    <% var meta = node.get('meta') %>
    <% _.each(meta, function(groupEntries, group) { %>
      <div class="accordion-group">
        <div class="accordion-heading">
          <div class="accordion-toggle" data-group="<%- group %>">
            <%- group %>
            <span><%- showSummary(meta, group) %></span>
            <i class="icon-expand pull-right"></i>
          </div>
        </div>
        <div class="accordion-body collapse">
          <div class="accordion-inner">
            <% if (_.isArray(groupEntries)) { %>
              <% if (group == 'interfaces' || group == 'disks') groupEntries = _.sortBy(groupEntries, 'name') %>
              <% _.each(groupEntries, function(entry) { %>
                <div class="nested-object">
                  <% _.each(sortEntryProperties(entry), function(propertyName) { %>
                    <div><label><%- showPropertyName(propertyName) %></label><%- showPropertyValue(group, propertyName, entry[propertyName]) %></div>
                  <% }) %>
                </div>
              <% }) %>
            <% } else if (_.isObject(groupEntries)) { %>
              <% var subentries = _.find(_.values(groupEntries), _.isArray) %>
              <% _.each(groupEntries, function(propertyValue, propertyName) { %>
                <% if (!_.isArray(propertyValue)) { %>
                  <div><label><%- showPropertyName(propertyName) %></label><%- showPropertyValue(group, propertyName, propertyValue) %></div>
                <% } %>
              <% }) %>
              <% if (_.isArray(subentries)) { %>
                <% _.each(subentries, function(subentry) { %>
                  <div class="nested-object">
                    <% _.each(sortEntryProperties(subentry), function(propertyName) { %>
                      <div><label><%- showPropertyName(propertyName) %></label><%- showPropertyValue(group, propertyName, subentry[propertyName]) %></div>
                    <% }) %>
                  </div>
                <% }) %>
              <% } %>
            <% } else { %>
              <div><%- groupEntries %></div>
            <% } %>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
</div>
<div class="modal-footer">
  <% if (node.get('role') && !deployment) { %>
    <button class="btn btn-edit-disks" data-dismiss="modal">Configure Disks</button>
  <% } %>
  <button class="btn node-modal-close" data-dismiss="modal">Close</button>
</div>
